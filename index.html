<!DOCTYPE html><html><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><title>忍術バトル Ver.19 (全公開版)</title><style>
body{font-family:sans-serif;text-align:center;background:#1a1a1a;color:#fff;margin:0;overflow:hidden;height:100vh;display:flex;flex-direction:column}
#menu-screen{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.95);z-index:200;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:20px;overflow-y:auto}
.btn-group{display:flex;flex-direction:column;gap:10px;margin-bottom:15px}
.mode-btn{width:260px;padding:12px;font-size:1rem;background:#444;color:#fff;border:2px solid #666;border-radius:10px;cursor:pointer;font-weight:700}
.mode-btn.selected{background:#e74c3c;border-color:#fff;box-shadow:0 0 15px #e74c3c}
.start-btn{width:200px;padding:15px;background:#27ae60;color:#fff;border:none;border-radius:30px;font-size:1.2rem;font-weight:700;cursor:pointer;box-shadow:0 4px 0 #1e8449}
.custom-btn{width:200px;padding:10px;background:#3498db;color:#fff;border:none;border-radius:8px;font-weight:bold;cursor:pointer;margin-bottom:10px}
.modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.95);display:none;flex-direction:column;align-items:center;z-index:300;padding:20px;overflow-y:auto}
.lib-section{width:100%;max-width:400px;margin-bottom:15px;background:#222;padding:10px;border-radius:10px}
.lib-grid{display:flex;justify-content:center;gap:8px}
.lib-item{width:60px;height:60px;border:2px solid #555;border-radius:5px;object-fit:cover}
.lib-item.active{border-color:#f1c40f;box-shadow:0 0 8px #f1c40f}
.player-area{height:40%;display:flex;flex-direction:column;justify-content:center;padding:10px;position:relative}
#p2-area{transform:rotate(180deg);border-bottom:2px solid #444}#p1-area{border-top:2px solid #444}
.hand{display:flex;justify-content:center;gap:8px;flex-wrap:wrap}
.card{width:60px;height:82px;border:2px solid #fff;border-radius:8px;cursor:pointer;overflow:hidden;position:relative;display:flex;flex-direction:column;align-items:center;justify-content:center}
.card[data-type="火"]{background:#d32f2f}.card[data-type="水"]{background:#1976d2}.card[data-type="土"]{background:#f57c00}.card[data-type="風"]{background:#388e3c}.card[data-type="雷"]{background:#fbc02d}
.card img{width:100%;height:100%;object-fit:cover;position:absolute;top:0;left:0;z-index:1}
.card-label{font-size:16px;font-weight:900;z-index:2;text-shadow:1px 1px 3px #000;background:rgba(0,0,0,0.3);width:100%;padding:2px 0}
.card.selected{transform:translateY(-12px);border-color:#f1c40f;box-shadow:0 0 15px #f1c40f}
#battle-center{height:20%;background:rgba(0,0,0,.7);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:10}
.decide-btn{width:150px;height:40px;font-size:1.1rem;border-radius:20px;border:none;background:#e74c3c;color:#fff;font-weight:700;cursor:pointer}
.waiting{opacity:.1;pointer-events:none}
#flash-div{position:fixed;top:0;left:0;width:100%;height:100%;z-index:1000;pointer-events:none}
@keyframes flash{0%{opacity:0}50%{background:#fff;opacity:0.8}100%{opacity:0}}
</style></head><body>

<div id="menu-screen">
    <h2>忍術バトル Ver.19</h2>
    <div class="btn-group">
        <button id="m-norm" class="mode-btn selected" onclick="selMode('N')">ノーマル (3戦/出し直しOK)</button>
        <button id="m-adv" class="mode-btn" onclick="selMode('A')">アドバンス (5戦/禁止手アリ)</button>
    </div>
    <div class="btn-group">
        <button id="p-com" class="mode-btn selected" onclick="selPlay('C')">1人 (vs COM:手札公開)</button>
        <button id="p-pvp" class="mode-btn" onclick="selPlay('P')">2人 (対面バトル)</button>
    </div>
    <button class="custom-btn" onclick="openLib()">イラストを選ぶ</button>
    <button class="start-btn" onclick="applyStart()">修行開始！</button>
</div>

<div id="lib-modal" class="modal">
    <h3>イラスト選択</h3>
    <div id="lib-container"></div>
    <button class="start-btn" onclick="closeLib()" style="margin-top:20px">決定</button>
</div>

<div id="flash-div"></div>
<div id="p2-area" class="player-area"><div id="p2-hand" class="hand"></div><button id="p2-btn" class="decide-btn" onclick="confirmMove(2)">決定</button></div>
<div id="battle-center">
    <div id="status-msg">いざ、勝負！</div>
    <div id="last-moves" style="font-size:1.1rem; font-weight:bold; color:#f1c40f; margin: 5px 0;">P1: ? vs P2: ?</div>
    <div id="score-line">P1: 0 | P2: 0</div>
</div>
<div id="p1-area" class="player-area"><button id="p1-btn" class="decide-btn" onclick="confirmMove(1)">決定</button><div id="p1-hand" class="hand"></div></div>
<div id="overlay" class="modal" style="justify-content:center"><h2>プレイヤー交代</h2><button class="mode-btn" onclick="closeOverlay()">準備完了</button></div>

<script>
const library = {
    '火': ['https://livedoor.blogimg.jp/pokeruto_narutostorm/imgs/9/d/9df794cc.png','https://dummyimage.com/100/d32f2f/fff&text=火2','https://dummyimage.com/100/d32f2f/fff&text=火3'],
    '水': ['https://ooyake01.com/wp-content/uploads/2019/07/%E6%89%89%E9%96%93.png','https://dummyimage.com/100/1976d2/fff&text=水2','https://dummyimage.com/100/1976d2/fff&text=水3'],
    '土': ['https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQgUZKzoGoqlDT7mUC9X8fE76pwS8yTZOsQJWSf0JLyzQ&s','https://dummyimage.com/100/f57c00/fff&text=土2','https://dummyimage.com/100/f57c00/fff&text=土3'],
    '風': ['https://otakotaku.com/asset/img/character/2017/10/uzumaki-naruto-59dbafb3a0d9ep.jpg','https://dummyimage.com/100/388e3c/fff&text=風2','https://dummyimage.com/100/388e3c/fff&text=風3'],
    '雷': ['https://images-na.ssl-images-amazon.com/images/I/71rse6gO0XL._CR550,250,1420,1420_.jpg','https://dummyimage.com/100/fbc02d/fff&text=雷2','https://dummyimage.com/100/fbc02d/fff&text=雷3']
};

let icons = {'火': library['火'][0], '水': library['水'][0], '土': library['土'][0], '風': library['風'][0], '雷': library['雷'][0]};
const rel={'火':'風','風':'雷','雷':'土','土':'水','水':'火'},typeOrd={'火':1,'水':2,'土':3,'風':4,'雷':5},types=['火','水','土','風','雷'];
let hands,scores,selected,confirmed,turn,gMode='N',pMode='C',p1D=[],p2D=[],firstPt=null,bannedStr=null;

function openLib(){
    const container = document.getElementById('lib-container'); container.innerHTML='';
    types.forEach(t=>{
        const sec = document.createElement('div'); sec.className='lib-section';
        sec.innerHTML = `<div class="lib-grid" id="grid-${t}"></div>`;
        container.appendChild(sec);
        const grid = document.getElementById(`grid-${t}`);
        library[t].forEach(url=>{
            const img = document.createElement('img'); img.src=url; img.className='lib-item' + (icons[t]===url?' active':'');
            img.onerror = () => { img.src = ""; img.style.background = "#555"; };
            img.onclick = ()=>{ icons[t]=url; Array.from(grid.children).forEach(i=>i.classList.remove('active')); img.classList.add('active'); };
            grid.appendChild(img);
        });
    });
    document.getElementById('lib-modal').style.display='flex';
}
function closeLib(){ document.getElementById('lib-modal').style.display='none'; }
function selMode(m){gMode=m; document.getElementById('m-norm').className=m==='N'?'mode-btn selected':'mode-btn'; document.getElementById('m-adv').className=m==='A'?'mode-btn selected':'mode-btn';}
function selPlay(p){pMode=p; document.getElementById('p-com').className=p==='C'?'mode-btn selected':'mode-btn'; document.getElementById('p-pvp').className=p==='P'?'mode-btn selected':'mode-btn';}
function applyStart(){document.getElementById('menu-screen').style.display='none';initGame();}

function initGame(){
    hands={1:[...types],2:[...types]}; scores={1:0,2:0}; selected={1:[],2:[]}; confirmed={1:!1,2:!1};
    turn=1; firstPt=null; bannedStr=null; p1D=[]; p2D=[];
    document.getElementById('status-msg').innerText="修行開始！";
    document.getElementById('last-moves').innerText="P1: ? vs P2: ?";
    document.getElementById('p2-btn').style.visibility=(pMode==='C')?'hidden':'visible';
    unlockArea(1); unlockArea(2); renderHands();
}

function renderHands(){
    for(let p=1;p<=2;p++){
        const t=document.getElementById(`p${p}-hand`); t.innerHTML="";
        // COM対戦でも常に手札が見えるように修正
        hands[p].forEach(n=>{
            const isSel=selected[p].includes(n),o=document.createElement("div");
            o.className=`card ${isSel?"selected":""}`; o.dataset.type=n;
            o.innerHTML=`<img src="${icons[n]}" onerror="this.style.display='none'"><div class="card-label">${n}</div>`;
            o.onclick=()=>{if(!confirmed[p]){isSel?selected[p]=selected[p].filter(x=>x!==n):selected[p].push(n);renderHands();}};
            t.appendChild(o);
        });
    }
    const limit=(gMode==='N')?3:5;
    document.getElementById('score-line').innerText=`P1: ${scores[1]} | P2: ${scores[2]} (戦目:${turn}/${limit})`;
}

function confirmMove(p){
    const s = selected[p].slice().sort((a,b)=>typeOrd[a]-typeOrd[b]);
    const moveStr = s.join("+");
    if(s.length===0) return;
    if(gMode==='A' && bannedStr && moveStr===bannedStr){ alert("禁止手です！"); return; }
    if(s.length===2 && !(s.includes('水') && s.includes('風'))){ alert("氷遁(水+風)のみ！"); return; }
    if(s.length===3 && !(s.includes('火') && s.includes('風') && s.includes('土'))){ alert("塵遁(火+風+土)のみ！"); return; }
    if(p===1) p1D=[...s]; else p2D=[...s];
    confirmed[p]=!0; selected[p]=[]; renderHands(); lockArea(p);
    if(confirmed[1]){
        if(pMode==='C') setTimeout(comLogic, 500);
        else if(confirmed[2]) battle();
        else showOverlay();
    }
}

function comLogic(){
    const h2=hands[2]; let possible=[];
    h2.forEach(c=>possible.push([c]));
    if(h2.includes('水')&&h2.includes('風')) possible.push(['水','風']);
    if(h2.includes('火')&&h2.includes('風')&&h2.includes('土')) possible.push(['火','風','土']);
    if(gMode==='A'&&bannedStr) possible=possible.filter(p=>p.sort((a,b)=>typeOrd[a]-typeOrd[b]).join("+")!==bannedStr);
    p2D = possible[Math.floor(Math.random()*possible.length)];
    confirmed[2]=!0; battle();
}

function battle(){
    const m1=p1D.sort((a,b)=>typeOrd[a]-typeOrd[b]), m2=p2D.sort((a,b)=>typeOrd[a]-typeOrd[b]);
    const s1=m1.join("+"), s2=m2.join("+");
    let win=0;
    
    // 履歴を即座に表示
    document.getElementById('last-moves').innerText=`P1: [${s1}] vs P2: [${s2}]`;

    if(m1.length > m2.length) win=1; else if(m2.length > m1.length) win=2;
    else if(m1.length===1 && rel[m1[0]]===m2[0]) win=1; else if(m1.length===1 && rel[m2[0]]===m1[0]) win=2;
    
    const f=document.getElementById('flash-div'); f.style.animation='none'; setTimeout(()=>{f.style.animation='flash 0.4s'},10);

    if(win!==0){
        scores[win]++; if(firstPt===null) firstPt=win;
        m1.forEach(c=>hands[1].splice(hands[1].indexOf(c),1));
        m2.forEach(c=>hands[2].splice(hands[2].indexOf(c),1));
        document.getElementById('status-msg').innerText=`P${win}の勝利！`; bannedStr=null; turn++;
    } else {
        if(gMode==='N'){
            if(s1===s2 && turn<3){ document.getElementById('status-msg').innerText="あいこ！再選択"; resetTurn(); return; }
            else { m1.forEach(c=>hands[1].splice(hands[1].indexOf(c),1)); m2.forEach(c=>hands[2].splice(hands[2].indexOf(c),1)); document.getElementById('status-msg').innerText="引き分け(カード消費)"; turn++; }
        } else {
            if(s1===s2 && turn===1){ bannedStr=s1; document.getElementById('status-msg').innerText="1戦目あいこ！禁止手確定"; resetTurn(); return; }
            else { m1.forEach(c=>hands[1].splice(hands[1].indexOf(c),1)); m2.forEach(c=>hands[2].splice(hands[2].indexOf(c),1)); document.getElementById('status-msg').innerText="引き分け(カード消費)"; bannedStr=null; turn++; }
        }
    }
    renderHands();
    const limit=(gMode==='N')?3:5;
    if(scores[1]>=2 || scores[2]>=2 || turn>limit || hands[1].length===0 || hands[2].length===0) setTimeout(judgeFinal, 800);
    else resetTurn();
}

function resetTurn(){ confirmed={1:!1,2:!1}; p1D=[]; p2D=[]; selected={1:[],2:[]}; unlockArea(1); unlockArea(2); renderHands(); }

function judgeFinal(){
    let resultText = "";
    if(scores[1] > scores[2]) resultText = "勝者: プレイヤー1";
    else if(scores[2] > scores[1]) resultText = "勝者: プレイヤー2";
    else {
        if(firstPt === 1) resultText = "同点につき、先取点によりP1勝利！";
        else if(firstPt === 2) resultText = "同点につき、先取点によりP2勝利！";
        else resultText = "完全なる引き分け！";
    }
    alert(`試合終了！\n${resultText}`);
    document.getElementById('menu-screen').style.display='flex';
}

function lockArea(p){ document.getElementById(`p${p}-area`).classList.add('waiting'); }
function unlockArea(p){ document.getElementById(`p${p}-area`).classList.remove('waiting'); }
function showOverlay(){ document.getElementById('overlay').style.display='flex'; }
function closeOverlay(){ document.getElementById('overlay').style.display='none'; }
</script></body></html>
